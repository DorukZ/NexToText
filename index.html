<!DOCTYPE html>
<html lang="tr" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NexToTask – Uygulama</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#10b981; --brand-300:#6ee7b7; --brand-500:#10b981; --brand-600:#059669;
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:rgba(0,0,0,.08);
      --badge:#eef2f7; --danger:#ef4444; --danger-50:#fef2f2; --shadow:0 10px 30px rgba(2,6,23,.05);
    }
    .dark:root{
      --bg:#0a0a0a; --card:#111111; --text:#e6e6e6; --muted:#a3a3a3; --border:rgba(255,255,255,.12);
      --badge:#1e1e1e; --danger:#f87171; --danger-50:#2b1d1d; --shadow:0 18px 40px rgba(0,0,0,.55);
    }
    html,body{ font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--text) }

    /* header */
    header.header{ position:sticky; top:0; z-index:40; background:var(--card); transition:box-shadow .18s ease; border-bottom:1px solid var(--border) }
    header.header.scrolled{ box-shadow:0 8px 24px rgba(0,0,0,.06) }

    /* sidebar (YouTube stili) */
    .sidebar{
      position:fixed; inset:0 auto 0 0; width:260px; background:var(--card);
      border-right:1px solid var(--border); transform:translateX(-270px);
      transition:transform .22s cubic-bezier(.2,.8,.2,1); z-index:45;
    }
    .sidebar.open{ transform:translateX(0) }
    .sidebar .item{ display:flex; align-items:center; gap:.7rem; padding:.65rem .9rem; border-radius:.75rem; }
    .sidebar .item.active{ background:rgba(16,185,129,.10); border:1px solid rgba(16,185,129,.25) }
    .sidebar .item:hover{ background:rgba(16,185,129,.06) }

    /* floating toggles */
    .floating-tab{
      position:fixed; right:8px; top:50%; transform:translateY(-50%); writing-mode:vertical-rl; text-orientation:mixed;
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:.55rem .35rem; box-shadow:var(--shadow); z-index:30;
    }

    /* cards */
    .soft-card{ background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow); }

    /* modal */
    .modal{ position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.36); backdrop-filter:blur(2px) }
    .modal.open{ display:flex }
    .modal-card{ transform:translateY(12px) scale(.98); opacity:0; transition:.18s ease; background:var(--card); color:var(--text) }
    .modal.open .modal-card{ transform:none; opacity:1 }
    .modal-card{ max-height:90vh; overflow:auto }

    /* calendar grid (ay görünümü) */
    .cal-grid{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.55rem }
    .cal-cell{ border:1px solid var(--border); border-radius:12px; padding:.55rem; background:var(--card); min-height:74px; display:flex; flex-direction:column; gap:.3rem }
    .cal-cell.sel{ box-shadow:0 0 0 2px var(--brand-300) inset }
    .cal-cell.today{ outline:2px solid var(--brand-500); outline-offset:-2px }
    .cal-day{ font-weight:700; font-size:.9rem }
    .badge{ background:var(--badge); color:var(--muted); border-radius:999px; font-size:.70rem; padding:.15rem .45rem; width:max-content }

    /* kanban */
    .dropzone{ min-height:420px }
    .dropzone.drag-over{ outline:2px dashed var(--brand-500); outline-offset:6px }

    /* chips + assignee dropdown */
    .chip{ display:inline-flex; align-items:center; gap:6px; background:#F0FDF4; color:#065F46; border:1px solid #DCFCE7; border-radius:9999px; padding:4px 10px; font-size:12px }
    .dark .chip{ background:#082f23; color:#a7f3d0; border-color:#064e3b }
    .assignee-menu{ position:absolute; z-index:70; width:260px; max-height:280px; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:.4rem }

    /* week/day calendar (takvim menüsü) */
    .week-grid{ display:grid; grid-template-columns:60px repeat(7,1fr); }
    .hour-row{ display:grid; grid-template-columns:60px repeat(7,1fr); }
    .hour-cell{ border-top:1px solid var(--border); height:44px; position:relative; }
    .hour-label{ font-size:.70rem; color:var(--muted); padding-right:.25rem; text-align:right; transform:translateY(-50%); position:relative; top:22px }
    .event{ position:absolute; left:6px; right:6px; border-radius:8px; padding:.25rem .4rem; background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.35); font-size:.75rem; cursor:move; }
    .resize-handle{ position:absolute; left:0; right:0; height:6px; cursor:ns-resize; }
    .resize-top{ top:-3px } .resize-bottom{ bottom:-3px }

    /* misc */
    .btn{ transition:transform .08s ease } .btn:active{ transform:translateY(1px) }
    body.no-scroll{ overflow:hidden }
  </style>
</head>
<body>

<!-- SIDEBAR (YouTube stili, NTT ile aç/kapa) -->
<aside id="sidebar" class="sidebar">
  <div class="px-4 py-3 flex items-center gap-3 border-b" style="border-color:var(--border)">
    <button id="closeSidebar" class="px-2 py-1 rounded-lg border" title="Kapat">✕</button>
    <div class="font-extrabold text-green-600 text-lg">NexToTask</div>
  </div>
  <nav class="p-3 space-y-1 text-sm">
    <button data-route="home" class="item active"><span>🏠</span> <span>Genel</span></button>
    <button data-route="tasks" class="item"><span>🗂️</span> <span>Görevler</span></button>
    <button data-route="calendar" class="item"><span>📅</span> <span>Takvim</span></button>
    <button data-route="daily" class="item"><span>🗓️</span> <span>Günlük Plan</span></button>
    <button data-route="team" class="item"><span>👥</span> <span>Ekip</span></button>
    <button data-route="reports" class="item"><span>📈</span> <span>Raporlar</span></button>
    <button data-route="templates" class="item"><span>📦</span> <span>Şablonlar</span></button>
    <button data-route="settings" class="item"><span>⚙️</span> <span>Ayarlar</span></button>
  </nav>
  <div class="absolute left-0 right-0 bottom-0 p-3">
    <button id="darkToggle" class="w-full px-3 py-2 rounded-xl border">🌙 Karanlık Mod</button>
  </div>
</aside>

<!-- HEADER -->
<header id="hdr" class="header">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
    <!-- NTT (sidebar toggle) -->
    <button id="brandBtn" class="px-2.5 py-1.5 rounded-lg border font-bold text-green-600">NTT</button>
    <div class="text-xl font-extrabold">NexToTask</div>

    <div class="ml-auto flex items-center gap-2">
      <button id="newTaskBtn" class="btn px-3 py-1.5 rounded-lg bg-green-600 text-white hover:bg-green-700">Yeni Görev +</button>
    </div>
  </div>
</header>

<!-- Dikey Görünüm aç/kapa -->
<button id="viewTab" class="floating-tab text-sm">Görünüm</button>

<!-- GÖRÜNÜM SAĞ PANEL -->
<aside id="viewSidebar" class="soft-card p-4 rounded-2xl" style="position:fixed; right:16px; top:86px; width:320px; max-height:calc(100vh - 110px); overflow:auto; transform:translateX(360px); transition:.2s; z-index:35;">
  <div class="font-bold mb-1">🔎 Görünüm</div>
  <input id="search" placeholder="Ara (başlık/etiket/açıklama)" class="w-full h-11 px-3 rounded-xl border bg-transparent focus:ring-2 focus:ring-green-200"/>
  <div class="grid grid-cols-2 gap-3 mt-3">
    <select id="filter" class="h-11 px-3 rounded-xl border bg-transparent focus:ring-2 focus:ring-green-200">
      <option value="pending">Bekleyen</option><option value="all">Tümü</option>
      <option value="date">Seçili Gün</option><option value="today">Bugün</option>
      <option value="upcoming">Yakında (7g)</option><option value="overdue">Geciken</option><option value="done">Tamamlanan</option>
    </select>
    <select id="sort" class="h-11 px-3 rounded-xl border bg-transparent focus:ring-2 focus:ring-green-200">
      <option value="created_desc">Sırala: Yeni → Eski</option>
      <option value="created_asc">Sırala: Eski → Yeni</option>
      <option value="due_asc">Sırala: Tarih (Artan)</option>
      <option value="due_desc">Sırala: Tarih (Azalan)</option>
      <option value="priority_desc">Sırala: Öncelik (Yüksek)</option>
    </select>
  </div>
  <select id="assigneeFilter" class="w-full h-11 px-3 rounded-xl border bg-transparent focus:ring-2 focus:ring-green-200 mt-3">
    <option value="all">Atanan: Tümü</option>
  </select>
  <div class="flex flex-wrap gap-2 pt-3">
    <button id="bulkDone" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50">Seçiliyi Tamamla</button>
    <button id="bulkUndo" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50">Seçiliyi Beklemeye Al</button>
    <button id="bulkDel"  class="px-3 py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50">Seçiliyi Sil</button>
  </div>
</aside>

<main id="main" class="max-w-7xl mx-auto px-4 py-6 md:py-10">

  <!-- ROUTE: GENEL -->
  <section id="route-home">
    <div class="soft-card rounded-2xl p-4 md:p-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold">📅 Mini Takvim</h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="mPrev" class="px-2 py-1 rounded-lg border">←</button>
          <div id="mTitle" class="px-2 font-semibold"></div>
          <button id="mNext" class="px-2 py-1 rounded-lg border">→</button>
        </div>
      </div>
      <div class="grid grid-cols-7 gap-2 text-xs text-gray-500 mb-2">
        <div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div>
      </div>
      <div id="miniCal" class="cal-grid"></div>
      <div class="text-xs text-gray-400 mt-2">İpucu: Kartı bir güne sürükleyerek tarih ata.</div>
    </div>

    <div class="soft-card rounded-2xl p-4 mt-4">
      <h3 class="font-semibold mb-2">📌 Seçilen Gündeki Görevler</h3>
      <div id="miniDayTasks" class="space-y-2 text-sm"></div>
    </div>
  </section>

  <!-- ROUTE: GÖREVLER -->
  <section id="route-tasks" class="hidden">
    <div class="flex items-center justify-between mb-3">
      <div class="text-xl font-bold">Görevler</div>
      <div class="flex items-center gap-2">
        <button id="switchList" class="px-3 py-1.5 rounded-lg border bg-green-50">Liste</button>
        <button id="switchKanban" class="px-3 py-1.5 rounded-lg border">Kanban</button>
      </div>
    </div>

    <section id="listView" class="space-y-3"></section>

    <section id="kanbanView" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="col soft-card rounded-2xl p-3">
        <div class="flex items-center justify-between pb-2">
          <h3 class="font-semibold">📦 BACKLOG</h3><button class="btn text-sm px-2 py-1 rounded-lg border hover:bg-gray-50" data-add="BACKLOG">➕</button>
        </div>
        <div id="col-BACKLOG" class="dropzone space-y-3 p-1" data-status="BACKLOG"></div><div class="text-xs text-gray-400 text-center py-2" data-empty="BACKLOG" hidden>Boş — buraya bırak</div>
      </div>
      <div class="col soft-card rounded-2xl p-3">
        <div class="flex items-center justify-between pb-2">
          <h3 class="font-semibold">📝 TODO</h3><button class="btn text-sm px-2 py-1 rounded-lg border hover:bg-gray-50" data-add="TODO">➕</button>
        </div>
        <div id="col-TODO" class="dropzone space-y-3 p-1" data-status="TODO"></div><div class="text-xs text-gray-400 text-center py-2" data-empty="TODO" hidden>Boş — buraya bırak</div>
      </div>
      <div class="col soft-card rounded-2xl p-3">
        <div class="flex items-center justify-between pb-2">
          <h3 class="font-semibold">⚙️ DOING</h3><button class="btn text-sm px-2 py-1 rounded-lg border hover:bg-gray-50" data-add="DOING">➕</button>
        </div>
        <div id="col-DOING" class="dropzone space-y-3 p-1" data-status="DOING"></div><div class="text-xs text-gray-400 text-center py-2" data-empty="DOING" hidden>Boş — buraya bırak</div>
      </div>
      <div class="col soft-card rounded-2xl p-3">
        <div class="flex items-center justify-between pb-2">
          <h3 class="font-semibold">✅ DONE</h3><button class="btn text-sm px-2 py-1 rounded-lg border hover:bg-gray-50" data-add="DONE">➕</button>
        </div>
        <div id="col-DONE" class="dropzone space-y-3 p-1" data-status="DONE"></div><div class="text-xs text-gray-400 text-center py-2" data-empty="DONE" hidden>Boş — buraya bırak</div>
      </div>
    </section>
  </section>

  <!-- ROUTE: TAKVİM -->
  <section id="route-calendar" class="hidden">
    <div class="flex items-center justify-between mb-3">
      <div class="text-xl font-bold">Takvim</div>
      <div class="flex items-center gap-2">
        <button id="calMonthBtn" class="px-3 py-1.5 rounded-lg border bg-green-50">Ay</button>
        <button id="calWeekBtn" class="px-3 py-1.5 rounded-lg border">Hafta</button>
        <button id="calTodayBtn" class="px-3 py-1.5 rounded-lg border">Bugün</button>
      </div>
    </div>

    <!-- Month view -->
    <div id="bigMonth" class="soft-card rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <button id="bigPrev" class="px-2 py-1 rounded-lg border">←</button>
          <div id="bigTitle" class="px-2 font-semibold"></div>
          <button id="bigNext" class="px-2 py-1 rounded-lg border">→</button>
        </div>
      </div>
      <div class="grid grid-cols-7 gap-2 text-xs text-gray-500 mb-2">
        <div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div>
      </div>
      <div id="bigGrid" class="cal-grid"></div>
      <div class="text-xs text-gray-400 mt-2">Bir güne çift tıklayınca gün (saatlik) görünümü açılır.</div>
    </div>

    <!-- Week view -->
    <div id="weekWrap" class="soft-card rounded-2xl p-3 mt-4 hidden">
      <div class="grid grid-cols-8 gap-2 text-xs text-gray-500 px-1 pb-2">
        <div></div><div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div>
      </div>
      <div id="weekGrid" class="week-grid"></div>
      <div class="text-xs text-gray-400 mt-2 px-1">Saat bloklarını sürükleyerek yer değiştirin, alt/üst kenardan sürükleyerek süreyi değiştirin.</div>
    </div>
  </section>

  <!-- Diğer rotalar boş placeholder -->
  <section id="route-daily" class="hidden soft-card rounded-2xl p-6 text-gray-500">Günlük plan ekranı burada geliştirilecek.</section>
  <section id="route-team" class="hidden soft-card rounded-2xl p-6 text-gray-500">Ekip yönetimi mevcut (Yeni Görev / Düzenle modallarındaki kişi listesiyle entegre).</section>
  <section id="route-reports" class="hidden soft-card rounded-2xl p-6 text-gray-500">Raporlar ekranı.</section>
  <section id="route-templates" class="hidden soft-card rounded-2xl p-6 text-gray-500">Şablonlar ekranı.</section>
  <section id="route-settings" class="hidden soft-card rounded-2xl p-6 text-gray-500">Ayarlar ekranı.</section>

  <!-- İstatistik & Odak bar -->
  <section class="flex flex-wrap items-center gap-2 my-5">
    <span id="stats" class="text-sm text-gray-500"></span>
    <span class="ml-auto text-xs text-gray-400">Görünüm: <b id="viewName">Liste</b></span>
  </section>

  <div id="focusBar" class="fixed bottom-3 left-0 right-0 flex justify-center pointer-events-none">
    <div class="pointer-events-auto soft-card rounded-2xl px-4 py-3 flex items-center gap-3">
      <span id="focusTask" class="text-sm">Odaklanılan görev yok</span>
      <span id="timer" class="font-mono text-sm px-2 py-1 rounded bg-gray-100 dark:bg-gray-800">25:00</span>
      <button id="startTimer" class="btn px-2 py-1 rounded-lg border hover:bg-gray-50">Başlat</button>
      <button id="pauseTimer" class="btn px-2 py-1 rounded-lg border hover:bg-gray-50">Duraklat</button>
      <button id="resetTimer" class="btn px-2 py-1 rounded-lg border hover:bg-gray-50">Sıfırla</button>
    </div>
  </div>
</main>

<!-- YENİ GÖREV MODALI (tamamen yenilendi) -->
<div id="createModal" class="modal">
  <div class="modal-card w-full max-w-3xl rounded-2xl p-5 shadow-xl">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg">🆕 Yeni Görev</h3>
      <button id="closeCreate" class="text-gray-500 hover:text-gray-300">Kapat</button>
    </div>

    <form id="createForm" data-enter-submit class="grid grid-cols-1 md:grid-cols-12 gap-3 text-sm">
      <input id="c_title" required placeholder="Görev başlığı" class="md:col-span-6 h-11 px-3 rounded-xl border"/>
      <input id="c_labels" placeholder="Etiketler (virgülle)" class="md:col-span-6 h-11 px-3 rounded-xl border"/>

      <label class="md:col-span-3 h-11 flex items-center gap-2 px-3 rounded-xl border">
        <span class="text-xs text-gray-500">Öncelik</span>
        <select id="c_priority" class="flex-1 bg-transparent outline-none">
          <option value="NORMAL">Normal</option><option value="HIGH">Yüksek</option><option value="LOW">Düşük</option>
        </select>
      </label>
      <input id="c_due" type="date" class="md:col-span-3 h-11 px-3 rounded-xl border"/>
      <div id="c_due_human" class="md:col-span-3 text-xs text-green-700 font-medium"></div>
      <input id="c_time" type="time" class="md:col-span-2 h-11 px-3 rounded-xl border" />
      <input id="c_estimate" type="number" min="0" placeholder="Tahmin (dk)" class="md:col-span-2 h-11 px-3 rounded-xl border"/>
      <select id="c_repeat" class="md:col-span-2 h-11 px-3 rounded-xl border">
        <option value="none">Tekrar yok</option><option value="daily">Günlük</option><option value="weekly">Haftalık</option><option value="monthly">Aylık</option>
      </select>

      <div class="md:col-span-12">
        <label class="block text-xs text-gray-500 mb-1">Atananlar / Ekip Grupları</label>
        <div id="c_chipbox" class="flex flex-wrap items-center gap-2 min-h-[44px] px-3 py-2 rounded-xl border cursor-pointer"></div>
        <div id="c_menu" class="assignee-menu hidden"></div>
      </div>

      <textarea id="c_desc" placeholder="Açıklama (opsiyonel)" class="md:col-span-12 px-3 py-2 rounded-xl border"></textarea>

      <button class="btn bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-xl font-medium md:col-span-12">Oluştur</button>
    </form>
  </div>
</div>

<!-- DÜZENLE MODALI (kişiler & yorumlar olduğu gibi) -->
<div id="editModal" class="modal">
  <div class="modal-card w-full max-w-3xl rounded-2xl p-5 shadow-xl">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg">✏️ Görevi Düzenle</h3>
      <button id="closeEdit" class="text-gray-500 hover:text-gray-300">Kapat</button>
    </div>

    <form id="editForm" data-enter-submit class="grid grid-cols-1 md:grid-cols-12 gap-3 text-sm">
      <input id="e_title" required class="md:col-span-6 h-11 px-3 rounded-xl border" placeholder="Başlık"/>
      <input id="e_labels" class="md:col-span-6 h-11 px-3 rounded-xl border" placeholder="Etiketler (virgülle)"/>

      <label class="md:col-span-3 h-11 flex items-center gap-2 px-3 rounded-xl border">
        <span class="text-xs text-gray-500">Öncelik</span>
        <select id="e_priority" class="flex-1 bg-transparent outline-none">
          <option value="NORMAL">Normal</option><option value="HIGH">Yüksek</option><option value="LOW">Düşük</option>
        </select>
      </label>
      <input id="e_due" type="date" class="md:col-span-3 h-11 px-3 rounded-xl border"/>
      <div id="e_due_human" class="md:col-span-3 text-xs text-green-700 font-medium"></div>
      <input id="e_time" type="time" class="md:col-span-2 h-11 px-3 rounded-xl border"/>
      <input id="e_est" type="number" min="0" class="md:col-span-2 h-11 px-3 rounded-xl border" placeholder="Tahmin (dk)"/>
      <select id="e_repeat" class="md:col-span-2 h-11 px-3 rounded-xl border">
        <option value="none">Tekrar yok</option><option value="daily">Günlük</option><option value="weekly">Haftalık</option><option value="monthly">Aylık</option>
      </select>

      <div class="md:col-span-12">
        <label class="block text-xs text-gray-500 mb-1">Atananlar / Ekip Grupları</label>
        <div id="e_chipbox" class="flex flex-wrap items-center gap-2 min-h-[44px] px-3 py-2 rounded-xl border cursor-pointer"></div>
        <div id="e_menu" class="assignee-menu hidden"></div>
      </div>

      <textarea id="e_desc" class="md:col-span-12 px-3 py-2.5 rounded-xl border" placeholder="Açıklama"></textarea>

      <div class="md:col-span-12 soft-card rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">💬 Yorumlar</h4>
          <span id="cCount" class="text-xs text-gray-400"></span>
        </div>
        <div id="cList" class="space-y-2 max-h-48 overflow-auto pr-1"></div>
        <div class="mt-2 flex gap-2">
          <input id="cInput" class="flex-1 h-10 px-3 rounded-lg border" placeholder="Yorum ekle ve Enter’a bas"/>
          <button id="cAdd" type="button" class="px-3 py-2 rounded-lg border hover:bg-gray-50 text-sm">Ekle</button>
        </div>
      </div>

      <div class="md:col-span-12 flex justify-between gap-2 mt-1">
        <button type="button" id="e_delete" class="btn px-3 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 text-sm">Sil</button>
        <button class="btn px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- TEMPLATES (Liste & Kanban kart) -->
<template id="taskTpl">
  <div class="task soft-card rounded-2xl p-4 flex flex-col gap-3 border" draggable="true">
    <div class="flex items-start justify-between gap-4">
      <div class="flex items-start gap-3 w-full">
        <input type="checkbox" class="sel mt-1 transform scale-110"/>
        <div class="w-full">
          <div class="flex items-center gap-2 flex-wrap">
            <h3 class="ttl font-semibold text-sm break-words"></h3>
            <span class="pill px-2 py-0.5 rounded-full text-xs"></span>
            <div class="tags flex flex-wrap gap-1"></div>
          </div>
          <p class="desc text-sm text-gray-600 mt-0.5 break-words"></p>
          <div class="meta text-xs text-gray-400 mt-1"></div>
          <div class="flex items-center gap-1 mt-1 assignees"></div>
          <div class="estimate text-xs text-gray-500"></div>
          <div class="text-xs text-gray-400">💬 <span class="cnum">0</span> yorum</div>
        </div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <button class="btn btn-focus text-xs px-3 py-1.5 rounded-lg border hover:bg-gray-50">Odak</button>
        <button class="btn btn-edit text-xs px-3 py-1.5 rounded-lg border hover:bg-gray-50">Düzenle</button>
      </div>
    </div>
    <details class="subwrap">
      <summary class="cursor-pointer text-sm">✅ Alt görevler</summary>
      <div class="space-y-2 mt-2">
        <div class="subs space-y-1"></div>
        <div class="flex gap-2">
          <input class="sub-input flex-1 px-3 py-2 rounded-lg border text-sm" placeholder="Alt görev ekle ve Enter’a bas"/>
          <button class="sub-add px-3 py-2 rounded-lg border hover:bg-gray-50 text-sm">Ekle</button>
        </div>
      </div>
    </details>
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <input type="checkbox" class="chk transform scale-110"/>
        <span class="text-sm">Tamamlandı</span>
      </div>
      <button class="btn btn-del text-xs px-3 py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50">Sil</button>
    </div>
  </div>
</template>
<template id="subTpl">
  <div class="flex items-center justify-between">
    <label class="flex items-center gap-2 text-sm">
      <input type="checkbox" class="s-chk"/>
      <span class="s-ttl"></span>
    </label>
    <button class="s-del text-xs px-2 py-0.5 rounded border border-red-200 text-red-600">Sil</button>
  </div>
</template>
<template id="kanbanCardTpl">
  <div draggable="true" class="kcard soft-card rounded-2xl p-3 cursor-move border">
    <div class="flex items-start justify-between gap-2">
      <div class="min-w-0">
        <div class="text-sm font-semibold k-ttl break-words"></div>
        <div class="text-xs text-gray-400 k-meta"></div>
        <div class="flex items-center gap-1 mt-1 k-assignees"></div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <button class="k-sub btn text-[11px] px-2 py-0.5 rounded-lg border hover:bg-gray-50">Alt görev +</button>
        <button class="k-edit btn text-[11px] px-2 py-0.5 rounded-lg border hover:bg-gray-50">Düzenle</button>
      </div>
    </div>
  </div>
</template>

<script>
/* ========== helpers ========== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const toLocalISODate = (d=new Date())=>{
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
};
const toLocalTime = (d=new Date())=>{
  return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
};
const todayISO = ()=> toLocalISODate(new Date());
const fmtDate = d => d ? new Date(d+'T00:00').toLocaleDateString('tr-TR') : '—';
// YENİ: Yazıyla uzun tarih (örn: Pazartesi, 20 Ağustos 2025)
const fmtDateLong = d => d ? new Intl.DateTimeFormat('tr-TR', { weekday:'long', day:'numeric', month:'long', year:'numeric' }).format(new Date(d+'T00:00')) : '—';
const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
const randColor=()=>['#6366F1','#10B981','#F59E0B','#EF4444','#3B82F6','#8B5CF6','#14B8A6'][Math.floor(Math.random()*7)];

/* ========== storage ========== */
const KEY='nextotask_tasks_v14', KEY_USERS='nextotask_users_v3', KEY_ROLES='nextotask_roles_v1';
function load(k,f){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(f)); }catch{ return f } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

let tasks=load(KEY,[]);
let users=load(KEY_USERS,[]);
let customRoles=load(KEY_ROLES,[]);
if(users.length===0){ users=[{id:'u_me', name:'Ben', color:randColor(), role:'owner'}]; save(KEY_USERS,users); }
tasks.forEach(t=>{ t.assigneeIds=t.assigneeIds||[users[0].id]; t.comments=t.comments||[]; });

/* ========== theme & header ========== */
const html = document.documentElement;
if(localStorage.getItem('nx_dark')==='1') html.classList.add('dark');
$('#darkToggle').addEventListener('click',()=>{ html.classList.toggle('dark'); localStorage.setItem('nx_dark', html.classList.contains('dark')?'1':'0'); });

document.addEventListener('scroll', ()=> $('#hdr').classList.toggle('scrolled', window.scrollY>6));

/* ========== sidebar toggle ========== */
const sidebar=$('#sidebar');
$('#brandBtn').onclick=()=> sidebar.classList.add('open');
$('#closeSidebar').onclick=()=> sidebar.classList.remove('open');
$$('.sidebar [data-route]').forEach(btn=>{
  btn.onclick=()=>{
    $$('.sidebar .item').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    routeTo(btn.dataset.route);
    sidebar.classList.remove('open');
  };
});

/* ========== görünüm sağ panel ========== */
const viewSide=$('#viewSidebar');
const viewTab=$('#viewTab');
const setViewOpen = (open)=> viewSide.style.transform = open?'translateX(0)':'translateX(360px)';
viewTab.onclick=()=> setViewOpen(viewSide.style.transform!=='translateX(0)');

/* ========== state ========== */
let selectedDate=todayISO();
let mRef=new Date(); // mini calendar
let bigRef=new Date(); // big calendar
let route='home';
let currentView='list';
let selectedIds=new Set();
let editingId=null;
let currentUserId=users[0].id;

/* ========== roles / visibility ========== */
const BASE_ROLES=['owner','manager','member'];
const userById=id=>users.find(u=>u.id===id)||null;
function roleCfg(role){
  if(role==='owner'||role==='manager') return {viewAll:true, assignAll:true};
  if(role==='member') return {viewAll:false, assignAll:false};
  const r=customRoles.find(x=>x.name===role); return r ? {viewAll:!!r.viewAll, assignAll:!!r.assignAll}:{viewAll:false, assignAll:false};
}
const canAssignAll=()=> roleCfg(userById(currentUserId)?.role||'member').assignAll;
function visibilityFilter(arr){ const cfg=roleCfg(userById(currentUserId)?.role||'member'); return cfg.viewAll? arr : arr.filter(t=>(t.assigneeIds||[]).includes(currentUserId)); }

/* ========== assignee UI (chips + dropdown) ========== */
function avatar(u,size=20){ const el=document.createElement('span'); el.className='rounded-full grid place-items-center text-white font-semibold'; el.style.width=size+'px'; el.style.height=size+'px'; el.style.background=u.color||'#999'; el.textContent=(u.name||'?').slice(0,1).toUpperCase(); return el; }
function paintChipbox(box, ids){
  box.innerHTML='';
  if(ids.length===0){ const ph=document.createElement('span'); ph.className='text-gray-400 text-sm'; ph.textContent='Kişi ekleyin…'; box.appendChild(ph); return; }
  ids.forEach(id=>{ const u=userById(id); if(!u) return; const chip=document.createElement('span'); chip.className='chip'; chip.appendChild(avatar(u,16)); chip.appendChild(document.createTextNode(u.name)); box.appendChild(chip); });
}
function openAssigneeMenu(anchor, selectedIdsArr, onChange){
  const menu=document.createElement('div'); menu.id='assMenuTmp'; menu.className='assignee-menu';
  const rect=anchor.getBoundingClientRect();
  menu.style.left = Math.min(rect.left, window.innerWidth-270)+'px';
  menu.style.top  = (rect.bottom+6)+'px';
  // roles
  const roles=[...new Set(users.map(u=>u.role))];
  if(roles.length){
    const h=document.createElement('div'); h.className='px-2 py-1 text-[12px] text-gray-400'; h.textContent='— Ekipler —'; menu.appendChild(h);
    roles.forEach(r=>{
      const row=document.createElement('label'); row.className='flex items-center justify-between px-2 py-1 rounded hover:bg-gray-50 cursor-pointer';
      const name=(r==='owner'?'Kurucu':(r==='manager'?'Yönetici':(r==='member'?'Üye':r)));
      row.innerHTML=`<div>${name}</div>`;
      const cb=document.createElement('input'); cb.type='checkbox';
      const members=users.filter(u=>u.role===r).map(u=>u.id);
      cb.checked = members.every(id=>selectedIdsArr.includes(id));
      cb.onchange=()=>{ members.forEach(id=>{ const i=selectedIdsArr.indexOf(id); if(cb.checked && i===-1) selectedIdsArr.push(id); if(!cb.checked && i!==-1) selectedIdsArr.splice(i,1); }); onChange([...selectedIdsArr]); };
      row.appendChild(cb); menu.appendChild(row);
    });
  }
  // users
  const hk=document.createElement('div'); hk.className='px-2 py-1 text-[12px] text-gray-400'; hk.textContent='— Kişiler —'; menu.appendChild(hk);
  users.forEach(u=>{
    const row=document.createElement('label'); row.className='flex items-center justify-between px-2 py-1 rounded hover:bg-gray-50 cursor-pointer';
    const left=document.createElement('div'); left.className='flex items-center gap-2'; left.appendChild(avatar(u,18)); left.appendChild(document.createTextNode(u.name)); row.appendChild(left);
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=selectedIdsArr.includes(u.id);
    cb.onchange=()=>{ const i=selectedIdsArr.indexOf(u.id); if(cb.checked && i===-1) selectedIdsArr.push(u.id); if(!cb.checked && i!==-1) selectedIdsArr.splice(i,1); onChange([...selectedIdsArr]); };
    row.appendChild(cb); menu.appendChild(row);
  });
  document.body.appendChild(menu);
  const closer=(e)=>{ if(!menu.contains(e.target) && e.target!==anchor){ menu.remove(); document.removeEventListener('mousedown',closer,true); } };
  setTimeout(()=> document.addEventListener('mousedown', closer, true), 0);
}

/* ========== view filters ========== */
let currentFilter='pending', searchTerm='', sortMode='created_desc', assigneeFilter='all';
$('#search').addEventListener('input', e=>{ searchTerm=e.target.value.toLowerCase(); render(); });
$('#filter').addEventListener('change', e=>{ currentFilter=e.target.value; render(); });
$('#sort').addEventListener('change', e=>{ sortMode=e.target.value; render(); });
$('#assigneeFilter').addEventListener('change', e=>{ assigneeFilter=e.target.value; render(); });

/* ========== route handling ========== */
function routeTo(r){
  route=r; ['home','tasks','calendar','daily','team','reports','templates','settings'].forEach(id=>{
    $('#route-'+id).classList.toggle('hidden', id!==r);
  });
  if(r==='home') { buildMini(); paintMiniDayTasks(); }
  if(r==='tasks') { render(); }
  if(r==='calendar') { buildBig(); }
  window.scrollTo({top:0});
}

/* ========== mini calendar (GENEL) ========== */
function monthTitle(d){ return d.toLocaleDateString('tr-TR',{month:'long', year:'numeric'}); }
function buildMini(){
  $('#mTitle').textContent=monthTitle(mRef);
  const g=$('#miniCal'); g.innerHTML='';
  const first=new Date(mRef.getFullYear(), mRef.getMonth(), 1);
  const start=(first.getDay()+6)%7;
  const daysInMonth=new Date(mRef.getFullYear(), mRef.getMonth()+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1; d<=daysInMonth; d++) cells.push(new Date(mRef.getFullYear(), mRef.getMonth(), d));
  const countBy={}; tasks.forEach(t=>{ const dd=(t.dueDate||'').slice(0,10); if(!dd) return; countBy[dd]=(countBy[dd]||0)+1; });
  cells.forEach(c=>{
    const cell=document.createElement('div'); cell.className='cal-cell';
    if(!c){ cell.style.visibility='hidden'; g.appendChild(cell); return; }
    const iso=toLocalISODate(c);
    const day=document.createElement('div'); day.className='cal-day'; day.textContent=c.getDate(); cell.appendChild(day);
    const cnt=countBy[iso]||0; if(cnt){ const b=document.createElement('div'); b.className='badge'; b.textContent=cnt+' görev'; cell.appendChild(b); }
    if(iso===selectedDate) cell.classList.add('sel');
    if(iso===todayISO()) cell.classList.add('today');
    cell.addEventListener('click',()=>{ selectedDate=iso; buildMini(); paintMiniDayTasks(); });
    cell.addEventListener('dragover', e=>{ e.preventDefault(); cell.classList.add('drag-over'); });
    cell.addEventListener('dragleave', ()=> cell.classList.remove('drag-over'));
    cell.addEventListener('drop', e=>{
      e.preventDefault(); cell.classList.remove('drag-over');
      const id=e.dataTransfer.getData('text/plain'); const t=tasks.find(x=>x.id===id); if(t){ t.dueDate=iso; save(KEY,tasks); buildMini(); paintMiniDayTasks(); render(); }
    });
    g.appendChild(cell);
  });
}
$('#mPrev').onclick=()=>{ mRef.setMonth(mRef.getMonth()-1); buildMini(); };
$('#mNext').onclick=()=>{ mRef.setMonth(mRef.getMonth()+1); buildMini(); };

function paintMiniDayTasks(){
  const wrap=$('#miniDayTasks'); wrap.innerHTML='';
  const dayTasks=visibilityFilter(tasks).filter(t=> (t.dueDate||'').slice(0,10)===selectedDate );
  if(dayTasks.length===0){ wrap.innerHTML='<div class="text-gray-400">Görev yok.</div>'; return; }
  dayTasks.forEach(t=>{
    const row=document.createElement('div'); row.className='soft-card rounded-xl px-3 py-2 flex items-center justify-between';
    row.innerHTML=`<div class="text-sm">${t.title}</div><div class="text-xs text-gray-400">${t.dueTime||'-'} • ${t.estimate||0} dk</div>`;
    wrap.appendChild(row);
  });
}

/* ========== list & kanban render ========== */
function applyFilter(arr){
  let out=visibilityFilter(arr).filter(t=> (t.title+' '+t.description+' '+(t.labels||[]).join(' ')).toLowerCase().includes(searchTerm));
  const today=todayISO();
  if(assigneeFilter!=='all') out=out.filter(t=> (t.assigneeIds||[]).includes(assigneeFilter));
  if(currentFilter==='date') out=out.filter(t=> (t.dueDate||'').slice(0,10)===selectedDate);
  if(currentFilter==='today') out=out.filter(t=> (t.dueDate||'').slice(0,10)===today && t.status!=='DONE');
  if(currentFilter==='upcoming') out=out.filter(t=>t.status!=='DONE' && t.dueDate && (Date.parse(t.dueDate)-Date.now())<=7*86400000 && (t.dueDate>=today));
  if(currentFilter==='overdue') out=out.filter(t=>t.status!=='DONE' && t.dueDate && t.dueDate<today);
  if(currentFilter==='pending') out=out.filter(t=>t.status!=='DONE');
  if(currentFilter==='done') out=out.filter(t=>t.status==='DONE');
  return out;
}
function applySort(out){
  out=out.slice();
  if(sortMode==='created_desc') out.sort((a,b)=> Date.parse(b.createdAt)-Date.parse(a.createdAt));
  if(sortMode==='created_asc') out.sort((a,b)=> Date.parse(a.createdAt)-Date.parse(b.createdAt));
  if(sortMode==='due_asc') out.sort((a,b)=> (Date.parse(a.dueDate||'9999-12-31') - Date.parse(b.dueDate||'9999-12-31')));
  if(sortMode==='due_desc') out.sort((a,b)=> (Date.parse(b.dueDate||'0001-01-01') - Date.parse(a.dueDate||'0001-01-01')));
  if(sortMode==='priority_desc'){ const p={HIGH:2,NORMAL:1,LOW:0}; out.sort((a,b)=> p[b.priority]-p[a.priority]); }
  return out;
}

function render(){
  // assignee filter options
  const f=$('#assigneeFilter'); f.innerHTML='<option value="all">Atanan: Tümü</option>'; users.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.name; f.appendChild(o); });

  const visible=visibilityFilter(tasks);
  const total=visible.length, done=visible.filter(t=>t.status==='DONE').length;
  const estPending=visible.filter(t=>t.status!=='DONE').reduce((s,t)=>s+(t.estimate||0),0);
  const estDone=visible.filter(t=>t.status==='DONE').reduce((s,t)=>s+(t.estimate||0),0);
  $('#stats').textContent=`Toplam: ${total} • Bekleyen: ${total-done} • Tamamlanan: ${done} • Tahmin Bekleyen: ${estPending} dk • Tam: ${estDone} dk`;
  $('#viewName').textContent=currentView==='list'?'Liste':'Kanban';

  if(route==='tasks'){
    if(currentView==='list'){ $('#listView').classList.remove('hidden'); $('#kanbanView').classList.add('hidden'); renderList(); }
    else { $('#listView').classList.add('hidden'); $('#kanbanView').classList.remove('hidden'); renderKanban(); }
  }
}

document.querySelector('#taskTpl'); // ensure templates loaded
function renderList(){
  const list=$('#listView'); list.innerHTML='';
  selectedIds.forEach(id=>{ if(!tasks.find(t=>t.id===id)) selectedIds.delete(id); });
  const tpl=$('#taskTpl'), subTpl=$('#subTpl');
  const arr=applySort(applyFilter(tasks));
  if(!arr.length){ const empty=document.createElement('div'); empty.className='soft-card rounded-2xl p-6 text-center text-gray-500'; empty.textContent='Görev yok. Üstten ekleyin veya filtreyi değiştirin.'; list.appendChild(empty); return; }
  arr.forEach(t=>{
    const node=tpl.content.cloneNode(true);
    const root=node.querySelector('.task'); root.dataset.id=t.id;
    root.classList.toggle('selected', selectedIds.has(t.id));
    root.addEventListener('click', (e)=>{ if(e.target.closest('button,input,textarea,select,summary')) return; toggleSelect(t.id, root); });
    root.addEventListener('dblclick', ()=> openEdit(t));
    root.addEventListener('dragstart',ev=>{ ev.dataTransfer.effectAllowed='move'; ev.dataTransfer.setData('text/plain', t.id); });

    node.querySelector('.ttl').textContent=t.title;
    node.querySelector('.desc').textContent=t.description||'';
    node.querySelector('.cnum').textContent=t.comments?.length||0;
    const pill=node.querySelector('.pill'); let pillText='Normal', pillCls='bg-gray-100 text-gray-700'; if(t.priority==='HIGH'){ pillText='Yüksek'; pillCls='bg-red-100 text-red-700' } if(t.priority==='LOW'){ pillText='Düşük'; pillCls='bg-yellow-100 text-yellow-700' } pill.textContent=pillText; pill.className=`pill px-2 py-0.5 rounded-full text-xs ${pillCls}`;
    // YENİ: uzun yazıyla tarih
    node.querySelector('.meta').textContent=`Tarih: ${fmtDateLong(t.dueDate)} ${t.dueTime?('• '+t.dueTime):''} • Oluşturma: ${new Date(t.createdAt).toLocaleString('tr-TR')}`;
    const tags=node.querySelector('.tags'); tags.innerHTML=''; (t.labels||[]).forEach(l=>{ const s=document.createElement('span'); s.className='px-2 py-0.5 rounded-full text-xs bg-green-50 text-green-700 border border-green-100'; s.textContent='#'+l; tags.appendChild(s); });
    const aWrap=node.querySelector('.assignees'); aWrap.innerHTML=''; (t.assigneeIds||[]).forEach(id=> aWrap.appendChild(avatar(userById(id)||users[0])) );
    node.querySelector('.estimate').textContent=t.estimate?`• ${t.estimate} dk`:'';

    const chk=node.querySelector('.chk'); chk.checked=t.status==='DONE';
    chk.addEventListener('change', ()=>{ t.status=chk.checked?'DONE':'TODO'; save(KEY,tasks); render(); });

    const subsWrap=node.querySelector('.subs');
    function paintSubs(){ subsWrap.innerHTML=''; (t.subtasks||[]).forEach((s,idx)=>{ const sn=subTpl.content.cloneNode(true); const c=sn.querySelector('.s-chk'); const st=sn.querySelector('.s-ttl'); c.checked=!!s.done; st.textContent=s.title; if(s.done) st.classList.add('line-through','text-gray-400'); c.addEventListener('change', ()=>{ s.done=c.checked; save(KEY,tasks); }); sn.querySelector('.s-del').addEventListener('click',()=>{ t.subtasks.splice(idx,1); save(KEY,tasks); paintSubs(); render(); }); subsWrap.appendChild(sn); }); }
    paintSubs();
    const subInput=node.querySelector('.sub-input'); node.querySelector('.sub-add').addEventListener('click', ()=> addSubtask(t, subInput, paintSubs)); subInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addSubtask(t, subInput, paintSubs); }});

    node.querySelector('.btn-del').addEventListener('click', ()=>{ tasks=tasks.filter(x=>x.id!==t.id); save(KEY,tasks); render(); buildMini(); buildBig(); });
    node.querySelector('.btn-edit').addEventListener('click', ()=> openEdit(t));
    node.querySelector('.btn-focus').addEventListener('click', ()=> openFocus(t));
    const sel=node.querySelector('.sel'); sel.checked=selectedIds.has(t.id); sel.addEventListener('change', ()=>{ sel.checked?selectedIds.add(t.id):selectedIds.delete(t.id); root.classList.toggle('selected', sel.checked); });
    list.appendChild(node);
  });
}
function addSubtask(t, input, repaint){ const val=input.value.trim(); if(!val) return; t.subtasks=t.subtasks||[]; t.subtasks.push({ title:val, done:false }); input.value=''; save(KEY,tasks); repaint(); }

/* kanban */
function renderKanban(){
  ['BACKLOG','TODO','DOING','DONE'].forEach(st=>{
    const col=$('#col-'+st); col.innerHTML=''; makeDroppable(col, (taskId,beforeId)=> moveTask(taskId, st, beforeId));
    const cards=applyFilter(tasks.filter(t=>t.status===st));
    cards.forEach(t=>{
      const node=$('#kanbanCardTpl').content.cloneNode(true);
      const card=node.querySelector('.kcard'); card.dataset.id=t.id;
      node.querySelector('.k-ttl').textContent=t.title;
      // YENİ: uzun yazıyla tarih kanbanda
      node.querySelector('.k-meta').textContent=`${t.labels?.map(l=>'#'+l).join(' ')||''} • ${fmtDateLong(t.dueDate)} ${t.dueTime?('• '+t.dueTime):''} • ${t.estimate? t.estimate+' dk':''}`;
      const as=node.querySelector('.k-assignees'); as.innerHTML=''; (t.assigneeIds||[]).forEach(id=> as.appendChild(avatar(userById(id)||users[0])) );
      card.addEventListener('click', (e)=>{ if(e.target.closest('button,input')) return; toggleSelect(t.id, card); });
      card.addEventListener('dblclick', ()=> openEdit(t));
      card.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', t.id); setTimeout(()=>card.classList.add('opacity-50'),0); });
      card.addEventListener('dragend', ()=> card.classList.remove('opacity-50'));
      node.querySelector('.k-sub').addEventListener('click', ()=>{ const val=prompt('Alt görev başlığı:'); if(!val) return; t.subtasks=t.subtasks||[]; t.subtasks.push({title:val,done:false}); save(KEY,tasks); render(); });
      node.querySelector('.k-edit').addEventListener('click', ()=> openEdit(t));
      col.appendChild(node);
    });
    const emptyEl=document.querySelector(`[data-empty="${st}"]`); if(emptyEl) emptyEl.hidden=cards.length!==0;
  });
}
function makeDroppable(el, onDrop){
  el.addEventListener('dragover', ev=>{ ev.preventDefault(); ev.dataTransfer.dropEffect='move'; el.classList.add('drag-over'); }, true);
  el.addEventListener('dragleave', ()=> el.classList.remove('drag-over'), true);
  el.addEventListener('drop', ev=>{
    ev.preventDefault(); el.classList.remove('drag-over');
    const id=ev.dataTransfer.getData('text/plain');
    const beforeCard=ev.target.closest('.kcard'); const beforeId=beforeCard? beforeCard.dataset.id:null;
    if(id) onDrop(id, beforeId);
  }, true);
}
function moveTask(id,newStatus,beforeId){
  const t=tasks.find(x=>x.id===id); if(!t) return;
  const fromIndex=tasks.indexOf(t); tasks.splice(fromIndex,1); t.status=newStatus;
  if(beforeId){ const idx=tasks.findIndex(x=>x.id===beforeId); tasks.splice(idx>=0?idx:tasks.length,0,t); }
  else tasks.push(t);
  save(KEY,tasks); render(); buildMini(); buildBig();
}

/* ========== big month calendar (TAKVİM) ========== */
function buildBig(){
  $('#bigTitle').textContent=monthTitle(bigRef);
  const grid=$('#bigGrid'); grid.innerHTML='';
  const first=new Date(bigRef.getFullYear(), bigRef.getMonth(), 1);
  const start=(first.getDay()+6)%7;
  const daysInMonth=new Date(bigRef.getFullYear(), bigRef.getMonth()+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1; d<=daysInMonth; d++) cells.push(new Date(bigRef.getFullYear(), bigRef.getMonth(), d));
  const countBy={}; tasks.forEach(t=>{ const dd=(t.dueDate||'').slice(0,10); if(!dd) return; countBy[dd]=(countBy[dd]||0)+1; });
  cells.forEach(c=>{
    const cell=document.createElement('div'); cell.className='cal-cell';
    if(!c){ cell.style.visibility='hidden'; grid.appendChild(cell); return; }
    const iso=toLocalISODate(c);
    const day=document.createElement('div'); day.className='cal-day'; day.textContent=c.getDate(); cell.appendChild(day);
    const cnt=countBy[iso]||0; if(cnt){ const b=document.createElement('div'); b.className='badge'; b.textContent=cnt+' görev'; cell.appendChild(b); }
    if(iso===todayISO()) cell.classList.add('today');
    if(iso===selectedDate) cell.classList.add('sel');
    cell.ondblclick=()=> openWeekForDay(iso);
    grid.appendChild(cell);
  });
}
$('#bigPrev').onclick=()=>{ bigRef.setMonth(bigRef.getMonth()-1); buildBig(); };
$('#bigNext').onclick=()=>{ bigRef.setMonth(bigRef.getMonth()+1); buildBig(); };
$('#calMonthBtn').onclick=()=>{ $('#bigMonth').classList.remove('hidden'); $('#weekWrap').classList.add('hidden'); };
$('#calWeekBtn').onclick=()=> openWeekForDay(selectedDate);
$('#calTodayBtn').onclick=()=>{ selectedDate=todayISO(); bigRef=new Date(); buildBig(); };

/* week view (saatlik) */
function openWeekForDay(dayISO){
  selectedDate=dayISO;
  const baseDate=new Date(dayISO+'T00:00');
  const monday=new Date(baseDate); const day=(baseDate.getDay()+6)%7; monday.setDate(baseDate.getDate()-day);
  const grid=$('#weekGrid'); grid.innerHTML='';
  // hours rows
  for(let h=0; h<24; h++){
    const row=document.createElement('div'); row.className='hour-row';
    const lbl=document.createElement('div'); lbl.className='hour-label'; lbl.textContent=String(h).padStart(2,'0')+':00'; row.appendChild(lbl);
    for(let d=0; d<7; d++){
      const cell=document.createElement('div'); cell.className='hour-cell'; cell.dataset.day=d; cell.dataset.hour=h;
      // create on drag
      let creating=false, startY=0, ghost=null;
      cell.addEventListener('mousedown', (e)=>{
        if(e.button!==0) return;
        creating=true; startY=e.offsetY; ghost=document.createElement('div'); ghost.className='event'; ghost.style.top=(e.offsetY)+'px'; ghost.style.height='22px'; ghost.textContent='Yeni'; cell.appendChild(ghost);
      });
      cell.addEventListener('mousemove', (e)=>{
        if(!creating||!ghost) return;
        const top=Math.min(startY, e.offsetY), bottom=Math.max(startY, e.offsetY);
        ghost.style.top=top+'px'; ghost.style.height=Math.max(22,bottom-top)+'px';
      });
      window.addEventListener('mouseup', ()=>{ if(!creating||!ghost) return; creating=false; const rect=cell.getBoundingClientRect(); const top=parseInt(ghost.style.top); const h1 = clamp(h + top/44, 0, 24); const dur=Math.max(0.5, parseInt(ghost.style.height)/44); ghost.remove(); // create task
        const dayDate=new Date(monday); dayDate.setDate(monday.getDate()+d);
        const dateISO=toLocalISODate(dayDate);
        const startMin=Math.round((h1%1)*60); const hour=Math.floor(h1);
        const dueTime=String(hour).padStart(2,'0')+':'+String(startMin).padStart(2,'0');
        const minutes=Math.round(dur*60);
        createTask({ title:'Yeni', due:dateISO, time:dueTime, estimate:minutes, priority:'NORMAL', repeat:'none', assignees:[currentUserId], labels:[], desc:'' });
        render(); buildMini(); buildBig(); openWeekForDay(dateISO);
      }, {once:true});
      row.appendChild(cell);
    }
    grid.appendChild(row);
  }
  // place events
  const weekTasks=applyFilter(tasks).filter(t=>{
    const td=new Date(t.dueDate+'T00:00'); return td>=monday && td<new Date(monday.getTime()+7*86400000);
  });
  weekTasks.forEach(t=>{
    const td=new Date(t.dueDate+'T00:00'); const d=(td.getDay()+6)%7;
    const h=parseInt((t.dueTime||'08:00').split(':')[0]||'8'); const m=parseInt((t.dueTime||'08:00').split(':')[1]||'0');
    const dur=(t.estimate||60)/60;
    const row=grid.querySelector(`.hour-row:nth-child(${h+1}) .hour-cell[data-day="${d}"]`);
    if(!row) return;
    const ev=document.createElement('div'); ev.className='event'; ev.style.top=(m/60*44)+'px'; ev.style.height=(Math.max(.5,dur)*44)+'px'; ev.textContent=t.title; ev.title=(t.dueTime||'')+' • '+(t.estimate||0)+'dk';
    // drag move
    let start=null, startTop=0;
    ev.addEventListener('mousedown', e=>{ if(e.target.classList.contains('resize-handle')) return; start=e.clientY; startTop=parseInt(ev.style.top||'0'); document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(start===null) return; const dy=e.clientY-start; ev.style.top=clamp(startTop+dy,0,44-10)+'px'; });
    window.addEventListener('mouseup', e=>{ if(start===null) return; const top=parseInt(ev.style.top||'0'); const newMin=Math.round(top/44*60); t.dueTime=String(h).padStart(2,'0')+':'+String(newMin).padStart(2,'0'); save(KEY,tasks); document.body.style.userSelect=''; start=null; });
    // resize
    const rt=document.createElement('div'); rt.className='resize-handle resize-top'; ev.appendChild(rt);
    const rb=document.createElement('div'); rb.className='resize-handle resize-bottom'; ev.appendChild(rb);
    let resizing=null, rStart=0, rHeight=0;
    rt.onmousedown=(e)=>{ resizing='top'; rStart=e.clientY; rHeight=parseInt(ev.style.height); startTop=parseInt(ev.style.top); document.body.style.userSelect='none'; };
    rb.onmousedown=(e)=>{ resizing='bottom'; rStart=e.clientY; rHeight=parseInt(ev.style.height); startTop=parseInt(ev.style.top); document.body.style.userSelect='none'; };
    window.addEventListener('mousemove', e=>{
      if(!resizing) return;
      const dy=e.clientY-rStart;
      if(resizing==='bottom'){ ev.style.height=Math.max(22, rHeight+dy)+'px'; }
      if(resizing==='top'){ const newTop=clamp(startTop+dy,0,44-10); ev.style.top=newTop+'px'; ev.style.height=Math.max(22, rHeight-(newTop-startTop))+'px'; }
    });
    window.addEventListener('mouseup', ()=>{
      if(!resizing) return;
      const mins=Math.round(parseInt(ev.style.height)/44*60); t.estimate=mins; save(KEY,tasks); document.body.style.userSelect=''; resizing=null;
    });

    row.appendChild(ev);
  });

  $('#bigMonth').classList.add('hidden');
  $('#weekWrap').classList.remove('hidden');
}

/* ========== selection helper ========== */
function toggleSelect(id, el){ if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); if(el) el.classList.toggle('selected'); }

/* ========== create/edit helpers ========== */
function createTask(p){
  const d = p.due || todayISO();
  const time = p.time || toLocalTime(new Date());
  const t={ id:'t_'+Date.now().toString(36),
    title:p.title, description:p.desc||'', labels:p.labels||[], priority:p.priority||'NORMAL',
    dueDate:d, dueTime:time, estimate:p.estimate||0, repeat:p.repeat||'none',
    assigneeIds:(p.assignees&&p.assignees.length?p.assignees:[currentUserId]), status:'TODO', subtasks:[], comments:[], activity:[], createdAt:new Date().toISOString()
  };
  tasks.unshift(t); save(KEY,tasks);
}

/* ========== New Task Modal ========== */
const cBox=$('#c_chipbox'), cMenu=$('#c_menu');
let cAssignees=[currentUserId];
function paintCreateChips(){ paintChipbox(cBox, cAssignees); }
cBox.onclick=(e)=>{ const sel=[...cAssignees]; openAssigneeMenu(cBox, sel, (ids)=>{ cAssignees=ids; paintCreateChips(); }); };
const cDueHuman = document.getElementById('c_due_human');
$('#newTaskBtn').onclick=()=>{
  $('#createForm').reset();
  $('#c_due').value=todayISO();
  $('#c_time').value=toLocalTime(new Date());
  $('#c_priority').value='NORMAL';
  cAssignees=[currentUserId]; paintCreateChips();
  if (cDueHuman) cDueHuman.textContent = fmtDateLong($('#c_due').value);
  open('createModal');
};
$('#closeCreate').onclick=()=> close('createModal');
$('#c_due').addEventListener('input', ()=>{ if (cDueHuman) cDueHuman.textContent = fmtDateLong($('#c_due').value); });
$('#createForm').addEventListener('submit', e=>{
  e.preventDefault();
  createTask({
    title:$('#c_title').value.trim(), labels:($('#c_labels').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    priority:$('#c_priority').value, due:$('#c_due').value||todayISO(), time:$('#c_time').value||toLocalTime(new Date()),
    estimate:parseInt($('#c_estimate').value||'0',10)||0, repeat:$('#c_repeat').value||'none',
    assignees:[...cAssignees], desc:$('#c_desc').value||''
  });
  close('createModal'); render(); buildMini(); buildBig();
});

/* ========== Edit Modal ========== */
const eBox=$('#e_chipbox');
let eAssignees=[];
function paintEditChips(){ paintChipbox(eBox, eAssignees); }
function openEdit(t){
  editingId=t.id;
  $('#e_title').value=t.title; $('#e_desc').value=t.description||''; $('#e_labels').value=(t.labels||[]).join(', ');
  $('#e_priority').value=t.priority; $('#e_due').value=t.dueDate||todayISO(); $('#e_time').value=t.dueTime||toLocalTime(new Date()); $('#e_est').value=t.estimate||0; $('#e_repeat').value=t.repeat||'none';
  eAssignees=[...(t.assigneeIds||[])]; paintEditChips(); paintComments(t);
  // YENİ: düzenle modalında yazıyla tarih
  $('#e_due_human').textContent = fmtDateLong($('#e_due').value);
  $('#e_due').oninput = () => { $('#e_due_human').textContent = fmtDateLong($('#e_due').value); };
  $('#e_delete').onclick=()=>{ tasks=tasks.filter(x=>x.id!==t.id); save(KEY,tasks); close('editModal'); render(); buildMini(); buildBig(); };
  open('editModal');
}
eBox.onclick=()=>{ const sel=[...eAssignees]; openAssigneeMenu(eBox, sel, (ids)=>{ eAssignees=ids; paintEditChips(); }); };
$('#closeEdit').onclick=()=> close('editModal');
$('#editForm').addEventListener('submit', e=>{
  e.preventDefault();
  const t=tasks.find(x=>x.id===editingId); if(!t) return;
  t.title=$('#e_title').value.trim()||t.title; t.description=$('#e_desc').value||'';
  t.labels=($('#e_labels').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  t.priority=$('#e_priority').value; t.dueDate=$('#e_due').value||todayISO(); t.dueTime=$('#e_time').value||toLocalTime(new Date()); t.estimate=parseInt($('#e_est').value||'0',10)||0; t.repeat=$('#e_repeat').value||'none';
  if(eAssignees.length) t.assigneeIds=[...eAssignees];
  save(KEY,tasks); close('editModal'); render(); buildMini(); buildBig();
});

/* comments (edit) */
function paintComments(t){
  const L=$('#cList'); L.innerHTML=''; const cc=t.comments||[]; $('#cCount').textContent=cc.length+' yorum';
  cc.forEach((c,i)=>{ const row=document.createElement('div'); row.className='flex items-start justify-between gap-2 rounded-xl border px-3 py-2';
    row.innerHTML=`<div><div class="text-sm">${c.text}</div><div class="text-xs text-gray-400">${new Date(c.at).toLocaleString('tr-TR')}</div></div>`;
    const del=document.createElement('button'); del.className='text-xs px-2 py-1 rounded border border-red-200 text-red-600'; del.textContent='Sil';
    del.onclick=()=>{ t.comments.splice(i,1); save(KEY,tasks); paintComments(t); render(); };
    row.appendChild(del); L.appendChild(row);
  });
}
$('#cAdd').onclick=addCommentFromBox;
$('#cInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addCommentFromBox(); }});
function addCommentFromBox(){
  const t=tasks.find(x=>x.id===editingId); if(!t) return;
  const v=$('#cInput').value.trim(); if(!v) return; t.comments=t.comments||[]; t.comments.unshift({ by:currentUserId, at:new Date().toISOString(), text:v });
  $('#cInput').value=''; save(KEY,tasks); paintComments(t); render();
}

/* ========== focus timer ========== */
let focusTaskId=null, timerSec=25*60, timerInt=null;
function updateTimer(){ const m=String(Math.floor(timerSec/60)).padStart(2,'0'), s=String(timerSec%60).padStart(2,'0'); $('#timer').textContent=`${m}:${s}`; }
function setFocusFromTask(t){ const base=t.estimate&&t.estimate>0 ? t.estimate : 25; const minutes=Math.max(5, base-5); timerSec=minutes*60; updateTimer(); }
function openFocus(t){ focusTaskId=t.id; $('#focusTask').textContent='Odak: '+t.title; setFocusFromTask(t); }
function stopInt(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }
$('#startTimer').onclick=()=>{ if(timerInt) return; timerInt=setInterval(()=>{ timerSec--; if(timerSec<=0){ stopInt(); alert('Odak süresi bitti!'); } updateTimer(); },1000); };
$('#pauseTimer').onclick=stopInt;
$('#resetTimer').onclick=()=>{ const t=tasks.find(x=>x.id===focusTaskId); if(t) setFocusFromTask(t); else { timerSec=25*60; updateTimer(); }};

/* ========== bulk actions ========== */
$('#bulkDone').onclick=()=>{ tasks.forEach(t=>{ if(selectedIds.has(t.id)) t.status='DONE' }); save(KEY,tasks); render(); };
$('#bulkUndo').onclick=()=>{ tasks.forEach(t=>{ if(selectedIds.has(t.id)) t.status='TODO' }); save(KEY,tasks); render(); };
$('#bulkDel').onclick=()=>{ tasks=tasks.filter(t=>!selectedIds.has(t.id)); selectedIds.clear(); save(KEY,tasks); render(); buildMini(); buildBig(); };

/* ========== switches & key handlers ========== */
$('#switchList').onclick=()=>{ currentView='list'; render(); };
$('#switchKanban').onclick=()=>{ currentView='kanban'; render(); };

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAll(); } });
function bindEnterSubmit(form){ form.addEventListener('keydown',(e)=>{ const isTA=e.target.tagName==='TEXTAREA'; if(e.key==='Enter' && (!isTA || (isTA && e.ctrlKey))){ e.preventDefault(); form.requestSubmit(); } }); }
['#editForm','#createForm'].forEach(s=>{ const f=$(s); if(f) bindEnterSubmit(f); });

/* ========== modal helpers ========== */
function open(id){ document.getElementById(id).classList.add('open'); document.body.classList.add('no-scroll'); }
function close(id){ document.getElementById(id).classList.remove('open'); const any=[...document.querySelectorAll('.modal')].some(m=>m.classList.contains('open')); if(!any) document.body.classList.remove('no-scroll'); }
function closeAll(){ ['editModal','createModal'].forEach(id=> close(id)); }

/* ========== init ========== */
routeTo('home'); buildMini(); buildBig(); render();
</script>
</body>
</html>
